<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Sales Summary 12</title>
  <!-- Bootstrap 5 (latest stable) from jsDelivr -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
      <h1 class="h4 mb-0">Sales Summary 12</h1>
      <div class="ms-2">
        <label for="currency-picker" class="form-label visually-hidden">Currency</label>
        <select id="currency-picker" class="form-select">
          <option value="USD" selected>USD</option>
          <option value="EUR">EUR</option>
          <option value="JPY">JPY</option>
          <option value="GBP">GBP</option>
          <option value="AUD">AUD</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="display-4 fw-bold" id="total-sales">0.00</div>
        <div class="text-muted">Total in <span id="total-currency">USD</span></div>
      </div>
    </div>
  </div>

  <script>
    // Simple CSV line parser that handles quoted fields
    function parseCSVLine(line) {
      const res = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          res.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      res.push(cur);
      return res.map(v => v.trim().replace(/^"(.*)"$/,'$1'));
    }

    // Sum the Sales(Rs.) column from data.csv
    function sumSalesFromCSV(text) {
      if (!text) return 0;
      const lines = text.split(/\r?\n/);
      // Find first non-empty line for header
      let headerIndex = lines.findIndex(l => l.trim() !== '');
      if (headerIndex < 0) return 0;
      const header = parseCSVLine(lines[headerIndex]);
      let idxSales = header.findIndex(h => h.trim() === 'Sales(Rs.)');
      // Fallback: if exact header not found, try to use a column that contains 'Sales'
      if (idxSales < 0) {
        idxSales = header.findIndex(h => /Sales/i.test(h));
      }
      if (idxSales < 0) return 0;

      let total = 0;
      for (let i = headerIndex + 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const cols = parseCSVLine(line);
        if (cols.length > idxSales) {
          const v = parseFloat(cols[idxSales]);
          if (!isNaN(v)) total += v;
        }
      }
      return total;
    }

    let totalRs = 0;
    let ratesMap = null;
    let currentCurrency = 'USD';
    let currencyPickerEl, totalSalesEl, totalCurrencyEl;

    function getRateForCurrency(cur) {
      if (!ratesMap) return null;
      // Direct mapping
      const direct = ratesMap[cur];
      if (typeof direct === 'number') return direct;
      // Nested structures, e.g., { "USD": { "rate": 0.012 } }
      if (ratesMap[cur] && typeof ratesMap[cur].rate === 'number') return ratesMap[cur].rate;
      // Common alternative: { "rates": { "USD": 0.012, ... } }
      if (ratesMap.rates && typeof ratesMap.rates[cur] === 'number') return ratesMap.rates[cur];
      return null;
    }

    function updateConvertedDisplay() {
      const rate = getRateForCurrency(currentCurrency);
      let converted = totalRs;
      if (typeof rate === 'number') converted = totalRs * rate;
      // Format with two decimals and comma separators
      const formatted = converted.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      totalSalesEl.textContent = formatted;
      totalCurrencyEl.textContent = currentCurrency;
    }

    async function loadDataAndRates() {
      // Load data.csv
      try {
        const dataRes = await fetch('data.csv');
        const text = await dataRes.text();
        totalRs = sumSalesFromCSV(text);
      } catch (e) {
        totalRs = 0;
      }
      updateConvertedDisplay();

      // Load rates.json
      try {
        const ratesRes = await fetch('rates.json');
        const json = await ratesRes.json();
        ratesMap = json;
      } catch (e) {
        ratesMap = null;
      }
      // After loading rates, update display to reflect potential conversion
      updateConvertedDisplay();
    }

    document.addEventListener('DOMContentLoaded', () => {
      currencyPickerEl = document.getElementById('currency-picker');
      totalSalesEl = document.getElementById('total-sales');
      totalCurrencyEl = document.getElementById('total-currency');

      // Initialize current currency with dropdown value
      if (currencyPickerEl) {
        currentCurrency = currencyPickerEl.value || 'USD';
        currencyPickerEl.addEventListener('change', (e) => {
          currentCurrency = e.target.value;
          updateConvertedDisplay();
        });
      }

      // Set the page title (as per original brief)
      document.title = 'Sales Summary 12';

      // Load data and rates, then render
      loadDataAndRates().then(() => {
        updateConvertedDisplay();
      });
    });
  </script>
</body>
</html>