<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sales Summary 12</title>
  <!-- Bootstrap 5 (latest stable) from jsDelivr -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Sales Summary 12</h1>

    <div class="row mb-4">
      <div class="col">
        <div class="card border-primary">
          <div class="card-body">
            <h5 class="card-title">Total Sales</h5>
            <p id="total-sales" class="card-text display-6 fw-semibold">0</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <h2 class="h5 mb-3">Product Sales</h2>
        <table id="product-sales" class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th scope="col">Product</th>
              <th scope="col">Total Sales (Rs.)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be injected here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const totalEl = document.getElementById('total-sales');
      const tableBody = document.querySelector('#product-sales tbody');

      function splitLine(line){
        const parts = [];
        let cur = '';
        let inQ = false;
        for (let i = 0; i < line.length; i++){
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i+1] === '"') { cur += '"'; i++; }
            else inQ = !inQ;
          } else if (ch === ',' && !inQ) {
            parts.push(cur);
            cur = '';
          } else {
            cur += ch;
          }
        }
        parts.push(cur);
        return parts;
      }

      function parseCSV(text){
        // Use the required line splitting method
        const lines = text.trim().split(/\r?\n/);
        if (lines.length === 0) return [];
        const header = splitLine(lines[0]);
        const rows = [];
        for (let i = 1; i < lines.length; i++){
          const line = lines[i];
          if (!line.trim()) continue;
          const values = splitLine(line);
          const obj = {};
          for (let j = 0; j < header.length; j++){
            const key = header[j] ?? ('col' + j);
            const val = values[j] ?? '';
            obj[key] = val;
          }
          rows.push(obj);
        }
        return rows;
      }

      async function loadData(){
        try {
          const resp = await fetch('data.csv');
          if (!resp.ok) throw new Error('Failed to fetch data.csv');
          const text = await resp.text();

          const rows = parseCSV(text);

          // Identify keys
          let productKey = null;
          let salesKey = null;
          if (rows.length > 0){
            const first = rows[0];
            for (const k of Object.keys(first)){
              const lk = k.toLowerCase();
              if (lk === 'product') productKey = k;
              if (lk.includes('sales')) salesKey = k;
            }
          }

          if (!productKey) {
            // Fallback: first column is product
            productKey = Object.keys(rows[0])[0];
          }
          if (!salesKey) {
            // No sales column found
            salesKey = Object.keys(rows[0]).find(k => k.toLowerCase().includes('sales'));
          }

          const perProduct = new Map();
          let total = 0;

          for (const r of rows){
            const product = (r[productKey] ?? '').toString() || '';
            const raw = salesKey ? (r[salesKey] ?? '') : '0';
            // extract numeric value
            const sale = parseFloat(raw.toString().replace(/[^0-9.\-]/g, '')) || 0;
            total += sale;
            if (perProduct.has(product)){
              perProduct.set(product, perProduct.get(product) + sale);
            } else {
              perProduct.set(product, sale);
            }
          }

          totalEl.textContent = total.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });

          // Render product table
          tableBody.innerHTML = '';
          const items = Array.from(perProduct.entries())
            .sort((a,b) => String(a[0]).localeCompare(String(b[0])));
          for (const [prod, val] of items){
            const tr = document.createElement('tr');
            const tdProd = document.createElement('td');
            tdProd.textContent = prod;
            const tdVal = document.createElement('td');
            tdVal.textContent = val.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            tr.appendChild(tdProd);
            tr.appendChild(tdVal);
            tableBody.appendChild(tr);
          }

        } catch (err){
          console.error(err);
          totalEl.textContent = '0';
        }
      }

      document.title = 'Sales Summary 12';
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadData);
      } else {
        loadData();
      }
    })();
  </script>
</body>
</html>